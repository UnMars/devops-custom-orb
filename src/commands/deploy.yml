description: "Deploy static files to Raspberry Pi"
parameters:
  ssh_host:
    type: string
    description: "Raspberry Pi Tailscale IP"
  ssh_user:
    type: string
    default: "demo"
  ssh_fingerprint:
    type: string
    description: "SSH key fingerprint registered in CircleCI"
steps:
  - add_ssh_keys:
      fingerprints:
        - <<parameters.ssh_fingerprint>>
  - run:
      name: SCP files
      command: scp -o StrictHostKeyChecking=no ./* <<parameters.ssh_user>>@<<parameters.ssh_host>>:/var/www/html/
  - run:
      name: Restart nginx
      command: ssh -o StrictHostKeyChecking=no <<parameters.ssh_user>>@<<parameters.ssh_host>> "sudo systemctl restart nginx"

  - run:
      name: Logout from Tailscale
      when: always
      command: sudo tailscale logout
