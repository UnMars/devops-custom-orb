description: "Build site and deploy to Raspberry Pi over Tailscale"
parameters:
  tailscale_authkey:
    type: env_var_name
    default: TAILSCALE_AUTHKEY
  ssh_host:
    type: string
    description: "Raspberry Pi Tailscale IP"
  ssh_user:
    type: string
    default: "demo"
  ssh_fingerprint:
    type: string
    description: "SSH fingerprint registered in CircleCI"
executor: node
steps:
  - checkout
  - run:
      name: Build Static Site 2
      command: |
        echo "Building static site..."
        npm install
        npm run build
  - run:
      command: |
        echo "Installing Tailscale..."
        curl -fsSL https://tailscale.com/install.sh | sh
        tailscale version
      name: Install Tailscale
  - run:
      command: |
        echo "Starting Tailscale service..."
        sudo systemctl start tailscaled
        sleep 5
        echo "Setting up Tailscale with hostname: circleci-runner"
        sudo tailscale up --authkey="$<<parameters.tailscale_authkey>>" --hostname="circleci-runner" --accept-routes
        echo "Waiting for Tailscale to connect..."
        sleep 10
      name: Connect to Tailscale
  - run:
      command: tailscale status
      name: Check Tailscale Status
  - add_ssh_keys:
      fingerprints:
        - <<parameters.ssh_fingerprint>>
  - run:
      command: |
        scp ./* "<<parameters.ssh_user>>@<<parameters.ssh_host>>:/var/www/html/"
        ssh "<<parameters.ssh_user>>@<<parameters.ssh_host>>" "sudo systemctl restart nginx"
      name: Deploy to Raspberry Pi
  - run:
      command: sudo tailscale logout
      name: Logout from Tailscale
      when: always
