description: "Build site and deploy to Raspberry Pi over Tailscale"
parameters:
  tailscale_authkey:
    type: env_var_name
    default: TAILSCALE_AUTHKEY
  ssh_host:
    type: string
    description: "Raspberry Pi Tailscale IP"
  ssh_user:
    type: string
    default: "demo"
  ssh_fingerprint:
    type: string
    description: "SSH fingerprint registered in CircleCI"
executor: cimg/node:18.20.3
steps:
  - build
  - run:
      name: Install Tailscale
      command: |
        curl -fsSL https://tailscale.com/install.sh | sh
  - tailscale:
      authkey: <<parameters.tailscale_authkey>>
      hostname: circleci-runner
  - deploy:
      ssh_host: <<parameters.ssh_host>>
      ssh_user: <<parameters.ssh_user>>
      ssh_fingerprint: <<parameters.ssh_fingerprint>>
