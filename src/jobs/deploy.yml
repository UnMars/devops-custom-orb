description: "Build site and deploy to Raspberry Pi over Tailscale"
parameters:
  tailscale_authkey:
    type: env_var_name
    default: TAILSCALE_AUTHKEY
  ssh_host:
    type: string
    description: "Raspberry Pi Tailscale IP"
  ssh_user:
    type: string
    default: "demo"
  ssh_fingerprint:
    type: string
    description: "SSH fingerprint registered in CircleCI"
executor: node
steps:
  - checkout
  - run:
      name: Build Static Site
      command: |
        echo "Building static site..."
        npm install
        npm run build
  - setup_environment:
      install_node: false
      install_tailscale: true
  - run:
      args:
        - <<parameters.tailscale_authkey>>
        - circleci-runner
      command: src/commands/scripts/setup-tailscale.sh
      name: Connect to Tailscale
  - run:
      command: tailscale status
      name: Check Tailscale Status
  - add_ssh_keys:
      fingerprints:
        - <<parameters.ssh_fingerprint>>
  - run:
      command: src/commands/scripts/deploy-to-pi.sh
      name: Deploy to Raspberry Pi
  - run:
      command: sudo tailscale logout
      name: Logout from Tailscale
      when: always
